<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Herrera | Resultados Semanales</title>

  <!-- ✅ SOLO SE AGREGA ESTO PARA GRAFICAS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f4f4f5; --card:#fff; --muted:#6b7280; --border:#e5e7eb;
      --text:#111827; --black:#0b0b0c; --soft:#fafafa; --ok:#16a34a; --warn:#a16207; --bad:#b91c1c;
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;
    }
    .brand h1{margin:0;font-size:22px}
    .brand p{margin:4px 0 0;color:var(--muted);font-size:13px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:999px;cursor:pointer;
      font-weight:600;font-size:13px;
    }
    .tab.active{background:var(--black);color:#fff;border-color:var(--black)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
    .grid{display:grid;gap:12px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width: 980px){.grid2,.grid3{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    select,input,textarea{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);font-size:14px;background:#fff;
    }
    textarea{min-height:220px;font-family:var(--mono);font-size:12px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;
    }
    .btn.black{background:var(--black);color:#fff;border-color:var(--black)}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .hint{color:var(--muted);font-size:13px;margin:0}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .msg{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--soft);font-size:13px}
    .msg.ok{border-color:#bbf7d0;background:#f0fdf4;color:#14532d}
    .msg.warn{border-color:#fde68a;background:#fffbeb;color:#713f12}
    .msg.bad{border-color:#fecaca;background:#fef2f2;color:#7f1d1d}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border);font-size:13px;text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
    td.num{text-align:right;font-variant-numeric:tabular-nums}
    .sectionTitle{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .sectionTitle h2{margin:0;font-size:16px}
    .small{font-size:12px;color:var(--muted)}
    .split{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{border:1px solid var(--border);border-radius:14px;padding:10px 12px;background:#fff}
    .kpi .box .t{font-size:12px;color:var(--muted)}
    .kpi .box .v{font-size:18px;font-weight:800;margin-top:2px}
    .right{text-align:right}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .mono{font-family:var(--mono)}

    /* ✅ SOLO PARA LAS GRAFICAS (NO TOCA LO DEMÁS) */
    .chartWrap{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
    .legendBox{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  </style>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div class="brand">
      <h1>Herrera | Resultados</h1>
      <p>Admin pega datos por empresa/semana. Viewer solo ve resultados.</p>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="datos">Datos</button>
      <button class="tab" data-tab="resultados">Resultados</button>
      <button class="tab" data-tab="config">Config</button>
    </div>
  </div>

  <div style="height:12px"></div>

  <!-- DATOS -->
  <div id="tab-datos" class="grid">

    <div class="card">
      <div class="split">
        <div>
          <div class="pill" id="modePill">Modo: Admin</div>
          <p class="hint">En <b>Datos</b> guardas textos por Empresa y Semana. Luego en <b>Resultados</b> se calculan rankings/comparativos.</p>
        </div>
        <div class="btnrow">
          <button class="btn" id="btnExport">Exportar JSON</button>
          <button class="btn" id="btnImport">Importar JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
          <button class="btn ghost" id="btnClearAll" title="Borra todo local">Borrar todo (local)</button>
        </div>
      </div>
      <div id="msgTop" class="msg" style="display:none;margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="sectionTitle">
        <h2>Entrada de datos</h2>
        <div class="small">Guardado local automático</div>
      </div>
      <div class="hr"></div>

      <div class="grid3">
        <div>
          <label>Empresa</label>
          <select id="companySelect"></select>
        </div>
        <div>
          <label>Año</label>
          <input id="yearInput" type="number" value="2026" />
        </div>
        <div>
          <label>Mes (1–12)</label>
          <input id="monthInput" type="number" min="1" max="12" value="1" />
        </div>
      </div>

      <div class="grid3">
        <div>
          <label>Semana del mes</label>
          <select id="weekSelect">
            <option value="1">Semana 1</option>
            <option value="2">Semana 2</option>
            <option value="3">Semana 3</option>
            <option value="4">Semana 4</option>
            <option value="5">Semana 5</option>
          </select>
        </div>
        <div>
          <label>Fecha inicio (Lun)</label>
          <input id="weekStart" type="date" />
        </div>
        <div>
          <label>Fecha fin (Sáb / cierre)</label>
          <input id="weekEnd" type="date" />
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Pegado Empresa (tabla de conceptos)</label>
          <textarea id="pasteCompany" placeholder="Pega aquí la tabla de empresa (Conceptos, Meta, Obtenido, ... Avance%)"></textarea>
        </div>
        <div>
          <label>Pegado Empleados (bloques Agenda / Calificación)</label>
          <textarea id="pasteEmployees" placeholder="Pega aquí los bloques de empleados (Agenda: ... Nombre ... Calificacion obtenida: ...)"></textarea>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn" id="btnPreview">Previsualizar</button>
        <button class="btn black" id="btnSave">Guardar Semana</button>
        <button class="btn" id="btnLoad">Cargar Semana</button>
        <button class="btn ghost" id="btnClearWeek">Limpiar cajas</button>
      </div>

      <div id="previewArea" class="grid" style="margin-top:12px;display:none">
        <div class="grid2">
          <div class="card" style="padding:14px">
            <div class="sectionTitle"><h2 style="font-size:14px;margin:0">Preview Empresa</h2><span class="small" id="companyKpiHint"></span></div>
            <div id="companyPreviewMsg" class="msg" style="display:none;margin-top:10px"></div>
            <div id="companyKpis" class="kpi" style="margin-top:10px"></div>
            <div style="margin-top:10px;max-height:280px;overflow:auto;border:1px solid var(--border);border-radius:12px">
              <table id="companyTable">
                <thead>
                  <tr>
                    <th>Concepto</th><th class="right">Meta</th><th class="right">Obtenido</th><th class="right">Peso%</th><th class="right">Avance%</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card" style="padding:14px">
            <div class="sectionTitle"><h2 style="font-size:14px;margin:0">Preview Empleados</h2><span class="small" id="empCount"></span></div>
            <div id="empPreviewMsg" class="msg" style="display:none;margin-top:10px"></div>

            <div style="margin-top:10px">
              <div class="small" style="font-weight:700;color:var(--text)">Top 5 (calificación)</div>
              <div id="top5" class="grid" style="gap:8px;margin-top:8px"></div>
            </div>

            <div style="margin-top:10px;max-height:280px;overflow:auto;border:1px solid var(--border);border-radius:12px">
              <table id="empTable">
                <thead>
                  <tr><th>Empleado</th><th class="right">Agenda</th><th class="right">Calificación</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

      <p class="hint" style="margin-top:10px">
        Tip: si quieres que el viewer vea EXACTAMENTE lo mismo, usa <b>Exportar JSON</b> (admin) y luego <b>Importar JSON</b> (viewer).
      </p>
    </div>

  </div>

  <!-- RESULTADOS -->
  <div id="tab-resultados" class="grid" style="display:none">

    <div class="card">
      <div class="sectionTitle">
        <h2>Resultados</h2>
        <span class="small">Se calcula con lo guardado en “Datos”</span>
      </div>
      <div class="hr"></div>

      <div class="grid3">
        <div>
          <label>Empresa</label>
          <select id="resCompany"></select>
        </div>
        <div>
          <label>Año</label>
          <input id="resYear" type="number" value="2026" />
        </div>
        <div>
          <label>Mes</label>
          <input id="resMonth" type="number" min="1" max="12" value="1" />
        </div>
      </div>

      <div class="btnrow">
        <button class="btn black" id="btnBuild">Actualizar resultados</button>
      </div>

      <div id="resMsg" class="msg warn" style="display:none;margin-top:10px"></div>

      <!-- ✅ GRAFICAS -->
      <div class="card" style="padding:14px;margin-top:12px">
        <div class="sectionTitle">
          <h2 style="font-size:14px;margin:0">Gráficas (mes acumulado)</h2>
          <span class="small">Independientes (siempre 14 empresas)</span>
        </div>
        <div class="hr"></div>

        <div class="grid2">
          <div>
            <div class="sectionTitle">
              <h2 style="font-size:14px;margin:0">Gráfica 1 · Ranking empresas (KPI% mes)</h2>
              <span class="small">Mayor a menor</span>
            </div>
            <p class="hint" style="margin-top:6px">KPI mensual ponderado por concepto (cap 100% por concepto).</p>
            <div class="chartWrap" style="margin-top:10px">
              <canvas id="chartRankingKPI"></canvas>
            </div>
          </div>

          <div>
            <div class="sectionTitle">
              <h2 style="font-size:14px;margin:0">Gráfica 2 · Eficiencia por Área (empleados)</h2>
              <span class="small">Promedio % empleados</span>
            </div>

            <div class="legendBox" style="margin-top:8px">
              <span class="small"><span class="dot" style="background:#16a34a"></span> Verde: &gt;70%</span>
              <span class="small"><span class="dot" style="background:#f59e0b"></span> Amarillo: 40–69%</span>
              <span class="small"><span class="dot" style="background:#dc2626"></span> Rojo: &lt;40%</span>
              <span class="small"><span class="dot" style="background:#9ca3af"></span> Gris: sin datos</span>
            </div>

            <p class="hint" style="margin-top:6px">
              (Suma % de vendedores del mes) / (# empleados con %).
            </p>

            <div class="chartWrap" style="margin-top:10px">
              <canvas id="chartEfficiencyArea"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Comparativo mensual -->
      <div class="card" style="padding:14px;margin-top:12px">
        <details id="cmpMonthlyDetails" open>
          <summary style="cursor:pointer;list-style:none">
            <div class="sectionTitle" style="align-items:center">
              <h2 style="font-size:14px;margin:0">Comparativo mensual (todas las empresas)</h2>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="small">Abrir/cerrar · dentro puedes ver “Desglose”</span>
                <button class="btn" id="btnOpenAllMonthly" type="button" style="padding:8px 10px;border-radius:999px;font-size:12px">
                  Abrir desgloses
                </button>
                <button class="btn" id="btnCloseAllMonthly" type="button" style="padding:8px 10px;border-radius:999px;font-size:12px">
                  Cerrar desgloses
                </button>
              </div>
            </div>
          </summary>

          <div style="margin-top:10px;max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px">
            <table id="cmpMonthly">
              <thead>
                <tr>
                  <th>Empresa</th>
                  <th class="right">KPI mes%</th>
                  <th class="right">Semanas</th>
                  <th>Desglose</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>

      <!-- Desglose del mes (matriz) para empresa seleccionada -->
      <div class="card" style="padding:14px;margin-top:12px">
        <details id="companyMatrixDetails">
          <summary style="cursor:pointer;font-weight:900">Desglose del mes (matriz)</summary>
          <div id="companyMatrixBox" style="margin-top:10px"></div>
        </details>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div class="card" style="padding:14px">
          <div class="sectionTitle">
            <h2 style="font-size:14px;margin:0">Empresa (semanas)</h2>
            <span class="small" id="resCompanyKpi"></span>
          </div>
          <div style="margin-top:10px;max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:12px">
            <table id="resWeeksTable">
              <thead>
                <tr>
                  <th>Semana</th>
                  <th>Fechas</th>
                  <th class="right">KPI%</th>
                  <th class="right">Conceptos</th>
                  <th>Desglose</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="padding:14px">
          <div class="sectionTitle">
            <h2 style="font-size:14px;margin:0">Ranking empleados</h2>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span class="small" id="resEmpCount"></span>
              <select id="empWeekView" style="padding:8px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px">
                <option value="mes" selected>Mes (ponderado)</option>
                <option value="1">Semana 1</option>
                <option value="2">Semana 2</option>
                <option value="3">Semana 3</option>
                <option value="4">Semana 4</option>
                <option value="5">Semana 5</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:12px">
            <table id="resEmpRank">
              <thead>
                <tr><th>#</th><th>Empleado</th><th class="right">Score%</th><th class="right">Semanas</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div class="card" style="padding:14px">
          <div class="sectionTitle">
            <h2 style="font-size:14px;margin:0">Comparativo semanal (todas las empresas)</h2>
            <select id="cmpWeekFilter" style="padding:8px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;width:auto">
              <option value="all" selected>Todas</option>
              <option value="1">Semana 1</option>
              <option value="2">Semana 2</option>
              <option value="3">Semana 3</option>
              <option value="4">Semana 4</option>
              <option value="5">Semana 5</option>
            </select>
          </div>
          <div style="margin-top:10px;max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:12px">
            <table id="cmpWeekly">
              <thead>
                <tr><th>Semana</th><th>Empresa</th><th class="right">KPI%</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="padding:14px">
          <div class="sectionTitle">
            <h2 style="font-size:14px;margin:0">Ranking general (todas las empresas)</h2>
            <select id="globalWeekView" style="padding:8px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;width:auto">
              <option value="mes" selected>Mes (ponderado)</option>
              <option value="1">Semana 1</option>
              <option value="2">Semana 2</option>
              <option value="3">Semana 3</option>
              <option value="4">Semana 4</option>
              <option value="5">Semana 5</option>
            </select>
          </div>
          <div style="margin-top:10px;max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:12px">
            <table id="globalRank">
              <thead>
                <tr><th>#</th><th>Empleado</th><th>Empresa</th><th class="right">Score%</th><th class="right">Semanas</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card" style="padding:14px;margin-top:12px">
        <div class="sectionTitle"><h2 style="font-size:14px;margin:0">Mejor vendedor por empresa (mes ponderado)</h2></div>
        <div style="margin-top:10px;max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:12px">
          <table id="bestByCompany">
            <thead>
              <tr><th>Empresa</th><th>Empleado</th><th class="right">Score%</th><th class="right">Semanas</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- CONFIG -->
  <div id="tab-config" class="grid" style="display:none">
    <div class="card">
      <div class="sectionTitle">
        <h2>Config</h2>
        <span class="small">Modo Admin/Viewer (solo para evitar edición accidental)</span>
      </div>
      <div class="hr"></div>

      <div class="grid2">
        <div>
          <label>Modo</label>
          <select id="modeSelect">
            <option value="admin">Admin (puede guardar)</option>
            <option value="viewer">Viewer (solo ver)</option>
          </select>
          <p class="hint" style="margin-top:8px">
            Esto no es seguridad real (GitHub Pages no tiene backend), pero ayuda a que el viewer no edite por accidente.
          </p>
        </div>

        <div>
          <label>Clave simple (opcional)</label>
          <input id="modePin" type="password" placeholder="Ej: 1234" />
          <p class="hint" style="margin-top:8px">Si pones pin, al cambiar a Admin lo pedirá.</p>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn black" id="btnSaveConfig">Guardar Config</button>
      </div>

      <div id="cfgMsg" class="msg ok" style="display:none;margin-top:10px"></div>
    </div>
  </div>

</div>

<script>
/** ==============================
 *  Config / Constantes
 *  ============================== */
const COMPANIES = [
  'HERRERA MOTORS SUR',
  'HERRERA MOTORS NORTE',
  'SEMINUEVOS',
  'EUROFRANCE AUTOS DE AGUASCALIENTES',
  'AMERITALI AUTOS SA DE CV',
  'SEMINUEVOS SUR',
  'HERRERA MOTORS LEATS',
  'LEATS SEMINUEVOS',
  'SEMINUEVOS 1ER ANILLO',
  'GAC',
  'FLOTILLAS',
  'CENTROS COMERCIALES',
  'ENTRENAMIENTO',
  'SU AUTO'
];

const STORAGE_KEY = "herrera_reportes_v1";
const CFG_KEY = "herrera_cfg_v1";

function $(id){ return document.getElementById(id); }
function fmtPct(n){
  if(n==null || !isFinite(n)) return "—";
  return n.toFixed(2) + "%";
}
function safeNum(s){
  if(s==null) return null;
  const t = String(s).replace(/,/g,"").replace(/[^\d.\-]/g,"").trim();
  if(!t) return null;
  const n = Number(t);
  return isFinite(n) ? n : null;
}
function normalizeLine(s){
  return String(s).replace(/\u00a0/g," ").trim();
}
const asArray = (x)=> Array.isArray(x) ? x : [];
function cap01(x){ return Math.max(0, Math.min(1, x)); }

/** ==============================
 *  Modelo de datos guardado
 *  data[year][month][key(company||week)] = record
 *  ============================== */
function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : {};
  }catch(e){ return {}; }
}
function saveData(obj){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}
function getBucket(data, year, month){
  data[year] ??= {};
  data[year][month] ??= {};
  return data[year][month];
}
function makeKey(company, week){ return company + "||" + week; }

/** ==============================
 *  ✅ KPI PONDERADO (Empresa)
 *  KPI = Σ pesoPct * min(obt/meta, 1)
 *  Si pesos no suman 100 -> normaliza a 100.
 *  ============================== */
function weightedKpiFromRows(rows){
  const valid = rows.filter(r => r && r.meta!=null && r.obtained!=null && r.weightPct!=null && isFinite(r.weightPct) && r.weightPct>0);
  if(valid.length===0) return null;

  const sumW = valid.reduce((s,r)=>s + (r.weightPct||0), 0);
  if(!sumW) return null;

  let score = 0;
  for(const r of valid){
    const ratio = (r.meta>0) ? cap01(r.obtained / r.meta) : 0;
    score += (r.weightPct / sumW) * ratio * 100;
  }
  return score;
}

/** ==============================
 *  Parser Empresa (TABLA REAL)
 *  Espera columnas:
 *  Conceptos | Meta | Obtenido | Obtenido% | Meta(=Peso) | Avance
 *  ============================== */
function parseCompanyPaste(text){
  const warnings=[], errors=[];
  const rawLines = String(text||"").split(/\r?\n/).map(normalizeLine).filter(Boolean);
  if(rawLines.length===0) return {rows:[], totals:{kpi:null, kpiReported:null, kpiCalc:null}, warnings, errors:["Pegado de empresa vacío."]};

  let startIdx = rawLines.findIndex(l=>{
    const x=l.toLowerCase();
    return x.includes("concept") && x.includes("meta") && x.includes("obten");
  });
  if(startIdx===-1){ warnings.push("No detecté header exacto; intentaré parsear igual."); startIdx=0; }
  else startIdx += 1;

  const rows=[];
  let kpiReported=null;

  for(let i=startIdx;i<rawLines.length;i++){
    const line = rawLines[i];

    // footer tipo: "80.93% 100% - -"
    const footer = line.match(/^\s*([0-9]+(?:\.[0-9]+)?)\s*%\s+/);
    if(footer && line.includes("-")){
      kpiReported = Number(footer[1]);
      continue;
    }

    // Preferencia: tabs (pegado real)
    if(line.includes("\t")){
      const cols = line.split("\t").map(x=>x.trim()).filter(x=>x.length>0);
      if(cols.length < 4) continue;

      const concept = cols[0];
      // debe tener letras (evita basura)
      if(!/[A-Za-zÁÉÍÓÚÑáéíóúñ]/.test(concept)) continue;

      const meta = safeNum(cols[1]);
      const obtained = safeNum(cols[2]);

      // peso: normalmente está en col 4 (index 4) si hay 6 cols.
      // si falta "Obtenido%" puede correrse, entonces tomamos "penúltima" como peso y "última" como avance.
      const weightRaw = cols.length >= 2 ? cols[cols.length-2] : null;
      const avanceRaw = cols.length >= 1 ? cols[cols.length-1] : null;

      const weightPct = safeNum(weightRaw);
      const avance = safeNum(avanceRaw);

      // nota meta tipo "(70%)"
      const metaNoteMatch = String(cols[1]||"").match(/\([^)]+\)/);
      const metaNote = metaNoteMatch ? metaNoteMatch[0] : null;

      rows.push({concept, meta, obtained, weightPct, avance, metaNote});
      continue;
    }

    // fallback (si viene sin tabs): intenta extraer
    const conceptMatch = line.match(/^\s*([A-Za-zÁÉÍÓÚÑáéíóúñ][^0-9]*)\s+/);
    if(!conceptMatch) continue;
    const concept = conceptMatch[1].trim();
    if(!concept || !/[A-Za-zÁÉÍÓÚÑáéíóúñ]/.test(concept)) continue;

    const after = line.slice(conceptMatch[0].length);
    const nums = after.match(/[0-9]+(?:\.[0-9]+)?/g) || [];
    const meta = nums.length>=1 ? safeNum(nums[0]) : null;
    const obtained = nums.length>=2 ? safeNum(nums[1]) : null;

    const percs = line.match(/[0-9]+(?:\.[0-9]+)?\s*%/g) || [];
    const avance = percs.length ? safeNum(percs[percs.length-1]) : null;
    const weightPct = (percs.length>=2) ? safeNum(percs[percs.length-2]) : null;

    rows.push({concept, meta, obtained, weightPct, avance, metaNote:null});
  }

  if(rows.length===0) errors.push("No detecté filas de conceptos. Revisa el pegado.");

  // KPI calculado PONDERADO
  const kpiCalc = weightedKpiFromRows(rows);
  const kpi = (kpiReported!=null && isFinite(kpiReported)) ? kpiReported : kpiCalc;

  if(kpiReported==null) warnings.push("No detecté KPI reportado (footer). Usaré KPI ponderado calculado.");
  if(kpiCalc==null) warnings.push("No pude calcular KPI ponderado (faltan pesos o metas).");

  return { rows, totals:{kpi, kpiCalc, kpiReported}, warnings, errors };
}

/** ==============================
 *  Parser Empleados
 *  - Ignora filas “concepto” sin letras (ej: "0 2 0")
 *  ============================== */
function parseEmployeesPaste(text){
  const warnings=[], errors=[];
  const lines = String(text||"").split(/\r?\n/).map(normalizeLine).filter(Boolean);
  if(lines.length===0) return {employees:[], warnings, errors:["Pegado de empleados vacío."]};

  const starts=[];
  for(let i=0;i<lines.length;i++){
    if(/^agenda:\s*\d+/i.test(lines[i])) starts.push(i);
  }
  if(starts.length===0) return {employees:[], warnings, errors:["No encontré bloques que empiecen con 'Agenda:'"]};

  const employees=[];
  for(let s=0;s<starts.length;s++){
    const start=starts[s];
    const end=(s+1<starts.length)?starts[s+1]:lines.length;
    const block=lines.slice(start,end);

    const agenda = Number((block[0].match(/^agenda:\s*(\d+)/i)||[])[1] || NaN);
    const agendaVal = isFinite(agenda)?agenda:null;

    let name="SIN NOMBRE";
    for(let i=1;i<Math.min(block.length,10);i++){
      const l=block[i];
      if(/^calificacion\s+obtenida/i.test(l)) continue;
      if(/^concepto\b/i.test(l)) continue;
      if(/[A-Za-zÁÉÍÓÚÑáéíóúñ]/.test(l) && !/:/.test(l)){
        name=l; break;
      }
    }

    let calif=null;
    for(const l of block){
      const m=l.match(/^calificacion\s+obtenida:\s*([0-9]+(?:\.[0-9]+)?)\s*%/i);
      if(m){ calif=Number(m[1]); break; }
    }

    const rows=[];
    const headerIdx = block.findIndex(l=>{
      const x=l.toLowerCase();
      return x.startsWith("concepto") && x.includes("obten") && x.includes("meta");
    });

    if(headerIdx !== -1){
      for(let i=headerIdx+1;i<block.length;i++){
        const l = block[i];

        if(/^citas\b/i.test(l)) break;
        if(/^total\b/i.test(l)) break;

        if(!l.includes("\t")) continue;

        const cols = l.split("\t").map(x=>x.trim()).filter(Boolean);
        if(cols.length < 4) continue;

        const concept = cols[0];
        // ✅ evita línea basura (no tiene letras)
        if(!/[A-Za-zÁÉÍÓÚÑáéíóúñ]/.test(concept)) continue;

        const obtained = safeNum(cols[1]);
        const meta = safeNum(cols[2]);
        const pesoPct = safeNum(cols[3]); // viene como 6.7% o 6.7

        if(!concept) continue;
        rows.push({concept, obtained, meta, pesoPct});
      }
    }

    employees.push({name, agenda:agendaVal, calif, rows});
  }

  const valid = employees.filter(e=>e.name!=="SIN NOMBRE").length;
  if(valid===0) errors.push("No detecté empleados válidos (nombre). Revisa el pegado.");

  return { employees, warnings, errors };
}
function topEmployees(employees, n=5){
  return [...employees]
    .filter(e=>e?.calif!=null && isFinite(e.calif))
    .sort((a,b)=>(b.calif||-1)-(a.calif||-1))
    .slice(0,n);
}

/** ==============================
 *  UI helpers
 *  ============================== */
function setMsg(el, text, type){
  if(!text){ el.style.display="none"; el.textContent=""; el.className="msg"; return; }
  el.style.display="block";
  el.textContent=text;
  el.className="msg " + (type||"");
}
function fillCompanies(selectEl){
  selectEl.innerHTML = "";
  for(const c of COMPANIES){
    const opt=document.createElement("option");
    opt.value=c; opt.textContent=c;
    selectEl.appendChild(opt);
  }
}
function currentKeyFromInputs(){
  const company = $("companySelect").value;
  const year = String($("yearInput").value||"");
  const month = String($("monthInput").value||"");
  const week = String($("weekSelect").value||"");
  return {company, year, month, week};
}

/** ==============================
 *  Mode (admin/viewer)
 *  ============================== */
function loadCfg(){
  try{ return JSON.parse(localStorage.getItem(CFG_KEY) || "{}"); }catch(e){ return {}; }
}
function saveCfg(cfg){
  localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
}
function applyMode(){
  const cfg = loadCfg();
  const mode = cfg.mode || "admin";
  $("modeSelect").value = mode;
  $("modePin").value = cfg.pin || "";
  $("modePill").textContent = "Modo: " + (mode==="admin" ? "Admin" : "Viewer");
  const isAdmin = mode==="admin";
  $("btnSave").disabled = !isAdmin;
  $("btnClearAll").disabled = !isAdmin;
  $("btnClearWeek").disabled = !isAdmin;
  $("pasteCompany").disabled = !isAdmin;
  $("pasteEmployees").disabled = !isAdmin;
  $("weekStart").disabled = !isAdmin;
  $("weekEnd").disabled = !isAdmin;
}

/** ==============================
 *  Datos tab actions
 *  ============================== */
function preview(){
  const pc = $("pasteCompany").value;
  const pe = $("pasteEmployees").value;

  const c = parseCompanyPaste(pc);
  const e = parseEmployeesPaste(pe);

  $("previewArea").style.display="block";

  setMsg($("companyPreviewMsg"), c.errors[0] || c.warnings[0] || "", c.errors.length?"bad":(c.warnings.length?"warn":"ok"));
  setMsg($("empPreviewMsg"), e.errors[0] || e.warnings[0] || "", e.errors.length?"bad":(e.warnings.length?"warn":"ok"));

  const kpiWrap = $("companyKpis");
  kpiWrap.innerHTML="";
  const boxes = [
    ["KPI usado", fmtPct(c.totals.kpi)],
    ["KPI calc (ponderado)", fmtPct(c.totals.kpiCalc)],
    ["Filas", String(c.rows.length)]
  ];
  boxes.forEach(([t,v])=>{
    const d=document.createElement("div");
    d.className="box";
    d.innerHTML=`<div class="t">${t}</div><div class="v">${v}</div>`;
    kpiWrap.appendChild(d);
  });

  const tb = $("companyTable").querySelector("tbody");
  tb.innerHTML="";
  c.rows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${r.concept}</td>
      <td class="num">${r.meta==null?"—":(r.meta.toFixed(2)+(r.metaNote?(" "+r.metaNote):""))}</td>
      <td class="num">${r.obtained==null?"—":r.obtained.toFixed(2)}</td>
      <td class="num">${r.weightPct==null?"—":r.weightPct.toFixed(2)+"%"}</td>
      <td class="num">${r.avance==null?"—":r.avance.toFixed(2)+"%"}</td>
    `;
    tb.appendChild(tr);
  });

  $("empCount").textContent = e.employees.length ? (e.employees.length + " empleados") : "";
  const top = topEmployees(e.employees,5);
  const topWrap = $("top5");
  topWrap.innerHTML="";
  top.forEach((x,i)=>{
    const d=document.createElement("div");
    d.className="msg";
    d.innerHTML = `<b>${i+1})</b> ${x.name} <span class="pill" style="float:right">${fmtPct(x.calif)} · Agenda ${x.agenda??"—"}</span>`;
    topWrap.appendChild(d);
  });

  const etb = $("empTable").querySelector("tbody");
  etb.innerHTML="";
  e.employees.forEach(x=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${x.name}</td>
      <td class="num">${x.agenda??"—"}</td>
      <td class="num">${fmtPct(x.calif)}</td>
    `;
    etb.appendChild(tr);
  });

  return {c,e};
}

function saveWeek(){
  const cfg=loadCfg();
  if((cfg.mode||"admin")!=="admin"){
    setMsg($("msgTop"), "Estás en modo Viewer. Cambia a Admin en Config para guardar.", "warn");
    return;
  }

  const {company, year, month, week} = currentKeyFromInputs();

  const start = $("weekStart").value || "";
  const end = $("weekEnd").value || "";

  const pc = $("pasteCompany").value;
  const pe = $("pasteEmployees").value;

  const parsedCompany = parseCompanyPaste(pc);
  const parsedEmployees = parseEmployeesPaste(pe);

  const data = loadData();
  const bucket = getBucket(data, year, month);

  bucket[makeKey(company, week)] = {
    company, year, month, week,
    start, end,
    companyText: pc,
    employeeText: pe,
    parsedCompany,
    parsedEmployees,
    savedAt: new Date().toISOString()
  };

  saveData(data);
  setMsg($("msgTop"), `Guardado ✅ ${company} | ${year}-${month} Semana ${week}`, "ok");
}

function loadWeek(){
  const {company, year, month, week} = currentKeyFromInputs();
  const data = loadData();
  const bucket = (((data||{})[year]||{})[month]||{});
  const rec = bucket[makeKey(company, week)];
  if(!rec){
    setMsg($("msgTop"), "No hay datos guardados para esa empresa/semana.", "warn");
    return;
  }
  $("weekStart").value = rec.start || "";
  $("weekEnd").value = rec.end || "";
  $("pasteCompany").value = rec.companyText || "";
  $("pasteEmployees").value = rec.employeeText || "";
  setMsg($("msgTop"), `Cargado ✅ ${company} | ${year}-${month} Semana ${week}`, "ok");
}

function clearWeekInputs(){
  const cfg=loadCfg();
  if((cfg.mode||"admin")!=="admin") return;
  $("weekStart").value="";
  $("weekEnd").value="";
  $("pasteCompany").value="";
  $("pasteEmployees").value="";
  $("previewArea").style.display="none";
  setMsg($("msgTop"), "Limpio ✅", "ok");
}

function exportJSON(){
  const data = loadData();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="herrera-reportes.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

function importJSON(file){
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const obj=JSON.parse(reader.result);
      saveData(obj);
      setMsg($("msgTop"), "Importado ✅ (recarga Resultados para ver cambios)", "ok");
    }catch(e){
      setMsg($("msgTop"), "Ese archivo no es JSON válido.", "bad");
    }
  };
  reader.readAsText(file);
}

function clearAll(){
  const cfg=loadCfg();
  if((cfg.mode||"admin")!=="admin"){
    setMsg($("msgTop"), "Modo Viewer no puede borrar.", "warn");
    return;
  }
  if(!confirm("¿Seguro que quieres borrar TODO lo guardado en este navegador?")) return;
  localStorage.removeItem(STORAGE_KEY);
  setMsg($("msgTop"), "Borrado local ✅", "ok");
}

/** Abrir/cerrar todos los desgloses mensuales */
function setMonthlyBreakdowns(open){
  const table = document.getElementById("cmpMonthly");
  if(!table) return;
  const details = table.querySelectorAll("details");
  details.forEach(d => { d.open = !!open; });
}

/** ==============================
 *  ✅ GRAFICAS
 *  ============================== */
let CHART_RANKING = null;
let CHART_EFF = null;

function destroyChart(ch){
  if(ch && typeof ch.destroy === "function") ch.destroy();
}
function colorByEfficiency(pct){
  if(pct==null || !isFinite(pct)) return "#9ca3af";
  if(pct >= 70) return "#16a34a";
  if(pct >= 40) return "#f59e0b";
  return "#dc2626";
}

function renderCharts({aggregateMonthlyCompanyKpi, employeeEfficiencyByCompany}){
  const rankData = COMPANIES.map(c=>{
    const kpi = aggregateMonthlyCompanyKpi(c).kpiMonth;
    return {company:c, value:(kpi!=null && isFinite(kpi))?kpi:0, has:(kpi!=null && isFinite(kpi))};
  }).sort((a,b)=>b.value-a.value);

  const effData = COMPANIES.map(c=>{
    const {avg, count} = employeeEfficiencyByCompany(c);
    const v = (avg!=null && isFinite(avg)) ? avg : 0;
    const has = (avg!=null && isFinite(avg)) && count>0;
    return {company:c, value:v, has};
  }).sort((a,b)=>b.value-a.value);

  const c1 = document.getElementById("chartRankingKPI");
  const c2 = document.getElementById("chartEfficiencyArea");
  if(!c1 || !c2 || typeof Chart==="undefined") return;

  destroyChart(CHART_RANKING);
  destroyChart(CHART_EFF);

  CHART_RANKING = new Chart(c1, {
    type: "bar",
    data: {
      labels: rankData.map(x=>x.company),
      datasets: [{
        label: "KPI% mes (ponderado)",
        data: rankData.map(x=>x.value),
        backgroundColor: rankData.map(x=> x.has ? "#111827" : "#9ca3af")
      }]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      plugins: {
        legend: { display: true },
        tooltip: { callbacks: { label: (ctx)=> `KPI%: ${Number(ctx.raw).toFixed(2)}%` } }
      },
      scales: {
        x: { beginAtZero:true, max:100, ticks:{ callback:(v)=> v+"%" } }
      }
    }
  });

  CHART_EFF = new Chart(c2, {
    type: "bar",
    data: {
      labels: effData.map(x=>x.company),
      datasets: [{
        label: "Eficiencia empleados% (promedio)",
        data: effData.map(x=>x.value),
        backgroundColor: effData.map(x=> x.has ? colorByEfficiency(x.value) : "#9ca3af")
      }]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      plugins: {
        legend: { display: true },
        tooltip: { callbacks: { label: (ctx)=> `Eficiencia: ${Number(ctx.raw).toFixed(2)}%` } }
      },
      scales: {
        x: { beginAtZero:true, max:100, ticks:{ callback:(v)=> v+"%" } }
      }
    }
  });
}

/** ==============================
 *  ✅ SCORE PONDERADO EMPLEADOS (MES)
 *  Score = Σ pesoPct * min(obt/meta,1)  (normalizando pesos)
 *  ============================== */
function computeWeightedScoreFromConceptSums(concepts){
  const valid = concepts.filter(c => c && c.pesoPct!=null && isFinite(c.pesoPct) && c.pesoPct>0 && c.metaSum!=null && isFinite(c.metaSum));
  if(valid.length===0) return null;

  const sumW = valid.reduce((s,c)=>s + (c.pesoPct||0), 0);
  if(!sumW) return null;

  let score = 0;
  for(const c of valid){
    const ratio = (c.metaSum && c.metaSum>0) ? cap01(c.obtainedSum/c.metaSum) : 0;
    score += (c.pesoPct/sumW) * ratio * 100;
  }
  return score;
}

function aggregateEmployeeMonthScore(blocks){
  const map = new Map(); // concept -> {metaSum, obtainedSum, pesoPct}
  const weeksSet = new Set();

  for(const b of blocks){
    weeksSet.add(b.week);
    for(const r of (b.rows||[])){
      const key = r.concept;
      if(!key) continue;
      if(!/[A-Za-zÁÉÍÓÚÑáéíóúñ]/.test(key)) continue; // seguridad extra

      if(!map.has(key)){
        map.set(key, {concept:key, metaSum:0, obtainedSum:0, pesoPct: (r.pesoPct!=null? r.pesoPct : null)});
      }
      const o = map.get(key);
      o.metaSum += (r.meta||0);
      o.obtainedSum += (r.obtained||0);
      if((o.pesoPct==null || !isFinite(o.pesoPct)) && r.pesoPct!=null) o.pesoPct = r.pesoPct;
    }
  }

  const concepts = [...map.values()];
  const score = computeWeightedScoreFromConceptSums(concepts);
  return {score, weeks: weeksSet.size, concepts};
}

/** ==============================
 *  Re-parse desde texto si faltan parsed (compat)
 *  ============================== */
function getParsedCompanyFromRec(rec){
  const parsed = rec?.parsedCompany;
  if(parsed && Array.isArray(parsed.rows) && parsed.rows.length>0) return parsed;
  const text = rec?.companyText || "";
  return parseCompanyPaste(text);
}
function getParsedEmployeesFromRec(rec){
  const parsed = rec?.parsedEmployees;
  if(parsed && Array.isArray(parsed.employees) && parsed.employees.length>0) return parsed;
  const text = rec?.employeeText || "";
  return parseEmployeesPaste(text);
}

/** ==============================
 *  Matriz (empresa)
 *  - Mes por concepto: suma metas/obtenidos
 *  - Avance por concepto del mes: (sumObt/sumMeta)*100 (sin cap aquí, solo tabla)
 *  - Avance General: KPI semanal guardado (promedio simple) SOLO PARA MOSTRAR
 *    (pero KPI MES real se calcula ponderado en comparativos)
 *  ============================== */
function buildWeeklyMatrixHTML(companyName, bucket){
  const conceptsOrder = ["Afluencia","Citas","Avaluos","Avalúos","Demos","Solicitudes","Aprobados","Ventas","Entregas"];
  const conceptMap = new Map();

  function normConcept(c){
    if(!c) return "";
    return String(c).trim().toLowerCase()
      .replace(/á/g,"a").replace(/é/g,"e").replace(/í/g,"i").replace(/ó/g,"o").replace(/ú/g,"u");
  }

  const weeks = [];
  const weekKpis = [];
  for(let w=1; w<=5; w++){
    const rec = bucket[makeKey(companyName, String(w))];
    if(!rec) continue;
    const pc = getParsedCompanyFromRec(rec);
    const rows = asArray(pc.rows);
    if(rows.length===0) continue;

    const kpi = pc?.totals?.kpi ?? null;
    if(kpi!=null && isFinite(kpi)) weekKpis.push({w, kpi});

    weeks.push({w, rows});
    for(const r of rows){
      const key = normConcept(r.concept);
      if(!key) continue;
      if(!conceptMap.has(key)){
        conceptMap.set(key, {label:r.concept, weeks:{}, metaMonth:0, obtMonth:0});
      }
      const obj = conceptMap.get(key);
      obj.weeks[w] = {meta:r.meta??null, obt:r.obtained??null, av:r.avance??null, note:r.metaNote||null};
      obj.metaMonth += (r.meta||0);
      obj.obtMonth += (r.obtained||0);
    }
  }

  if(conceptMap.size===0){
    return `<div class="msg warn">Sin datos para construir matriz (no se detectaron conceptos).</div>`;
  }

  const keys = [...conceptMap.keys()];
  keys.sort((a,b)=>{
    const ia = conceptsOrder.map(normConcept).indexOf(a);
    const ib = conceptsOrder.map(normConcept).indexOf(b);
    const aa = ia===-1 ? 999 : ia;
    const bb = ib===-1 ? 999 : ib;
    if(aa!==bb) return aa-bb;
    return (conceptMap.get(a).label||"").localeCompare(conceptMap.get(b).label||"");
  });

  const weekCols = [1,2,3,4,5];
  const avgWeekKpi = weekKpis.length ? (weekKpis.reduce((s,x)=>s+x.kpi,0)/weekKpis.length) : null;

  const headWeek = (w)=>`<th colspan="3" class="right">Semana ${w}</th>`;
  const subHead = (label)=>`<th class="right">${label}</th>`;

  const rowsHtml = keys.map(k=>{
    const c = conceptMap.get(k);
    const monthAv = (c.metaMonth>0) ? (c.obtMonth/c.metaMonth)*100 : null;

    const weekCells = weekCols.map(w=>{
      const cell = c.weeks[w] || {};
      const meta = cell.meta==null ? "—" : (Number(cell.meta).toFixed(2) + (cell.note?(" "+cell.note):""));
      const obt  = cell.obt==null ? "—" : Number(cell.obt).toFixed(2);
      const av   = cell.av==null ? "—" : Number(cell.av).toFixed(2)+"%";
      return `<td class="num">${meta}</td><td class="num">${obt}</td><td class="num">${av}</td>`;
    }).join("");

    return `
      <tr>
        <td><b>${c.label}</b></td>
        ${weekCells}
        <td class="num"><b>${c.metaMonth ? c.metaMonth.toFixed(2) : "—"}</b></td>
        <td class="num"><b>${c.obtMonth ? c.obtMonth.toFixed(2) : "—"}</b></td>
        <td class="num"><b>${monthAv==null ? "—" : monthAv.toFixed(2)+"%"}</b></td>
      </tr>
    `;
  }).join("");

  const advanceRow = `
    <tr>
      <td><b>Avance General (KPI semanal)</b></td>
      ${weekCols.map(w=>{
        const wk = weekKpis.find(x=>x.w===w);
        const v = wk ? wk.kpi.toFixed(2)+"%" : "—";
        return `<td class="num" colspan="3"><b>${v}</b></td>`;
      }).join("")}
      <td class="num" colspan="3"><b>${avgWeekKpi==null ? "—" : avgWeekKpi.toFixed(2)+"%"}</b></td>
    </tr>
  `;

  return `
    <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table style="min-width:980px">
        <thead>
          <tr>
            <th>Concepto</th>
            ${weekCols.map(headWeek).join("")}
            <th colspan="3" class="right">Mes</th>
          </tr>
          <tr>
            <th></th>
            ${weekCols.map(()=> `${subHead("Meta")}${subHead("Obtenido")}${subHead("Avance")}`).join("")}
            ${subHead("Meta")}${subHead("Obtenido")}${subHead("Avance")}
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
          ${advanceRow}
        </tbody>
      </table>
    </div>
    <p class="hint" style="margin-top:8px">Nota: KPI MES (comparativos/rankings) se calcula ponderado por concepto (cap 100%). La fila “Avance General” es solo KPI semanal guardado, para referencia visual.</p>
  `;
}

/** ==============================
 *  Resultados tab builder
 *  ============================== */
function buildResults(){
  const year = String($("resYear").value||"");
  const month = String($("resMonth").value||"");
  const company = $("resCompany").value;

  const data = loadData();
  const bucket = (((data||{})[year]||{})[month]||{});

  /** KPI mensual empresa (PONDERADO) */
  function aggregateMonthlyCompanyKpi(companyName){
    const map = new Map(); // concept -> {metaSum, obtainedSum, weightPct}
    let weeksUsed=0;

    for(let w=1; w<=5; w++){
      const rec = bucket[makeKey(companyName, String(w))];
      if(!rec) continue;

      const pc = getParsedCompanyFromRec(rec);
      const rows = asArray(pc.rows);
      if(rows.length===0) continue;

      weeksUsed++;

      rows.forEach(r=>{
        const key = r.concept;
        if(!key) return;

        if(!map.has(key)) map.set(key, {concept:key, metaSum:0, obtainedSum:0, weightPct: r.weightPct ?? null});
        const o=map.get(key);
        o.metaSum += (r.meta||0);
        o.obtainedSum += (r.obtained||0);
        if((o.weightPct==null || !isFinite(o.weightPct)) && r.weightPct!=null) o.weightPct = r.weightPct;
      });
    }

    const concepts = [...map.values()];
    // KPI mes = ponderado por concepto, cap 100% por concepto (ratio cap01)
    let kpiMonth = null;
    const valid = concepts.filter(c=>c.weightPct!=null && isFinite(c.weightPct) && c.weightPct>0 && c.metaSum!=null && isFinite(c.metaSum));
    if(valid.length){
      const sumW = valid.reduce((s,c)=>s+(c.weightPct||0),0);
      if(sumW){
        let score=0;
        for(const c of valid){
          const ratio = (c.metaSum>0) ? cap01(c.obtainedSum/c.metaSum) : 0;
          score += (c.weightPct/sumW) * ratio * 100;
        }
        kpiMonth = score;
      }
    }

    return {concepts, weeksUsed, kpiMonth};
  }

  /** promedio simple de % empleados (solo para gráfica 2) */
  function employeeEfficiencyByCompany(companyName){
    let sum=0, count=0;
    for(let w=1; w<=5; w++){
      const rec = bucket[makeKey(companyName, String(w))];
      if(!rec) continue;
      const pe = getParsedEmployeesFromRec(rec);
      const emps = asArray(pe.employees);
      emps.forEach(e=>{
        if(e?.calif==null || !isFinite(e.calif)) return;
        sum += e.calif;
        count += 1;
      });
    }
    const avg = count ? (sum/count) : null;
    return {avg, count};
  }

  // 0) Comparativo mensual
  const monthlyTbody = $("cmpMonthly").querySelector("tbody");
  monthlyTbody.innerHTML="";

  const monthlyRows = COMPANIES
    .map(c => {
      const agg = aggregateMonthlyCompanyKpi(c);
      return { company: c, kpi: agg.kpiMonth, weeks: agg.weeksUsed };
    })
    .sort((a, b) => (b.kpi ?? -1) - (a.kpi ?? -1));

  monthlyRows.forEach(r=>{
    const matrix = buildWeeklyMatrixHTML(r.company, bucket);
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${r.company}</td>
      <td class="num">${fmtPct(r.kpi)}</td>
      <td class="num">${r.weeks}</td>
      <td>
        <details>
          <summary style="cursor:pointer;font-weight:900">Desglose</summary>
          <div style="padding:10px 0">${matrix}</div>
        </details>
      </td>
    `;
    monthlyTbody.appendChild(tr);
  });

  // ✅ Matriz del mes (empresa seleccionada)
  $("companyMatrixBox").innerHTML = buildWeeklyMatrixHTML(company, bucket);

  // 1) Empresa por semanas
  const weeksTbody = $("resWeeksTable").querySelector("tbody");
  weeksTbody.innerHTML="";
  const weekKpis=[];
  let hasAny=false;

  for(let w=1; w<=5; w++){
    const rec = bucket[makeKey(company, String(w))];
    if(!rec) continue;

    const pc = getParsedCompanyFromRec(rec);
    const rows = asArray(pc.rows);
    const kpi = pc?.totals?.kpi ?? null;

    if(rows.length===0 && (kpi==null || !isFinite(kpi))) continue;
    hasAny=true;

    if(kpi!=null && isFinite(kpi)) weekKpis.push(kpi);

    const desgloseHTML = rows.length ? `
      <details>
        <summary style="cursor:pointer;font-weight:900">Ver</summary>
        <div style="padding:10px 0">
          <div style="max-height:240px;overflow:auto;border:1px solid var(--border);border-radius:12px">
            <table style="width:100%;border-collapse:collapse">
              <thead>
                <tr>
                  <th>Concepto</th>
                  <th class="right">Meta</th>
                  <th class="right">Obtenido</th>
                  <th class="right">Peso%</th>
                  <th class="right">Avance%</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r=>`
                  <tr>
                    <td>${r.concept}</td>
                    <td class="num">${r.meta==null?"—":(Number(r.meta).toFixed(2)+(r.metaNote?(" "+r.metaNote):""))}</td>
                    <td class="num">${r.obtained==null?"—":Number(r.obtained).toFixed(2)}</td>
                    <td class="num">${r.weightPct==null?"—":Number(r.weightPct).toFixed(2)+"%"}</td>
                    <td class="num">${r.avance==null?"—":Number(r.avance).toFixed(2)+"%"}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        </div>
      </details>
    ` : `<span class="small">Sin conceptos</span>`;

    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>Semana ${w}</td>
      <td class="mono">${(rec.start||"—")} → ${(rec.end||"—")}</td>
      <td class="num">${fmtPct(kpi)}</td>
      <td class="num">${rows.length}</td>
      <td>${desgloseHTML}</td>
    `;
    weeksTbody.appendChild(tr);
  }

  const avgKpiWeeks = weekKpis.length ? (weekKpis.reduce((a,b)=>a+b,0)/weekKpis.length) : null;
  $("resCompanyKpi").textContent = hasAny ? ("Promedio KPI semanas (referencia): " + fmtPct(avgKpiWeeks)) : "";

  // 2) Ranking empleados (empresa) Mes/Semana
  const viewEmp = $("empWeekView") ? $("empWeekView").value : "mes";
  let empRank = [];

  if(viewEmp === "mes"){
    const empBlocks = new Map(); // name -> [{week, rows}]
    for(let w=1; w<=5; w++){
      const rec = bucket[makeKey(company, String(w))];
      if(!rec) continue;

      const pe = getParsedEmployeesFromRec(rec);
      const emps = asArray(pe.employees);

      emps.forEach(e=>{
        if(!e?.name || e.name==="SIN NOMBRE") return;
        if(!Array.isArray(e.rows) || e.rows.length===0) return;

        if(!empBlocks.has(e.name)) empBlocks.set(e.name, []);
        empBlocks.get(e.name).push({week:w, rows:e.rows});
      });
    }

    empRank = [...empBlocks.entries()]
      .map(([name, blocks]) => {
        const r = aggregateEmployeeMonthScore(blocks);
        return { name, avg: r.score, weeks: r.weeks };
      })
      .filter(x=>x.avg!=null && isFinite(x.avg))
      .sort((a,b)=>(b.avg??-1)-(a.avg??-1));

  }else{
    const rec = bucket[makeKey(company, String(viewEmp))];
    const pe = rec ? getParsedEmployeesFromRec(rec) : {employees:[]};
    const emps = asArray(pe.employees);

    empRank = emps
      .filter(e=>e?.calif!=null && isFinite(e.calif))
      .map(e=>({name:e.name, avg:e.calif, weeks:1}))
      .sort((a,b)=>b.avg-a.avg);
  }

  const empTbody = $("resEmpRank").querySelector("tbody");
  empTbody.innerHTML="";
  empRank.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td class="num">${fmtPct(r.avg)}</td><td class="num">${r.weeks}</td>`;
    empTbody.appendChild(tr);
  });
  $("resEmpCount").textContent = empRank.length ? (empRank.length + " empleados") : "";

  // 3) Comparativo semanal con filtro
  const weekFilter = $("cmpWeekFilter") ? $("cmpWeekFilter").value : "all";
  const cmpBody = $("cmpWeekly").querySelector("tbody");
  cmpBody.innerHTML="";

  function renderWeek(w){
    const rows=[];
    for(const c of COMPANIES){
      const rec = bucket[makeKey(c, String(w))];
      if(!rec) continue;
      const pc = getParsedCompanyFromRec(rec);
      const kpi = pc?.totals?.kpi ?? null;
      if(kpi==null || !isFinite(kpi)) continue;
      rows.push({week:w, company:c, kpi});
    }
    rows.sort((a,b)=>(b.kpi)-(a.kpi));
    rows.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>Semana ${r.week}</td><td>${r.company}</td><td class="num">${fmtPct(r.kpi)}</td>`;
      cmpBody.appendChild(tr);
    });
  }

  if(weekFilter==="all"){
    for(let w=1; w<=5; w++) renderWeek(w);
  }else{
    renderWeek(Number(weekFilter));
  }

  // 4) Ranking general (todas) Mes/Semana
  const viewGlobal = $("globalWeekView") ? $("globalWeekView").value : "mes";
  const gBody = $("globalRank").querySelector("tbody");
  gBody.innerHTML = "";

  let globalRank = [];

  if(viewGlobal === "mes"){
    const globalBlocks = new Map(); // key name||company -> {name, company, blocks:[]}

    for(const c of COMPANIES){
      for(let w=1; w<=5; w++){
        const rec = bucket[makeKey(c, String(w))];
        if(!rec) continue;

        const pe = getParsedEmployeesFromRec(rec);
        const emps = asArray(pe.employees);

        emps.forEach(e=>{
          if(!e?.name || e.name==="SIN NOMBRE") return;
          if(!Array.isArray(e.rows) || e.rows.length===0) return;

          const key = e.name + "||" + c;
          if(!globalBlocks.has(key)) globalBlocks.set(key, {name:e.name, company:c, blocks:[]});
          globalBlocks.get(key).blocks.push({week:w, rows:e.rows});
        });
      }
    }

    globalRank = [...globalBlocks.values()]
      .map(o=>{
        const r = aggregateEmployeeMonthScore(o.blocks);
        return {name:o.name, company:o.company, avg:r.score, weeks:r.weeks};
      })
      .filter(x=>x.avg!=null && isFinite(x.avg))
      .sort((a,b)=>(b.avg??-1)-(a.avg??-1));

  } else {
    const w = String(viewGlobal);
    const list = [];

    for(const c of COMPANIES){
      const rec = bucket[makeKey(c, w)];
      if(!rec) continue;

      const pe = getParsedEmployeesFromRec(rec);
      const emps = asArray(pe.employees);

      emps.forEach(e=>{
        if(e?.calif==null || !isFinite(e.calif)) return;
        list.push({name:e.name, company:c, avg:e.calif, weeks:1});
      });
    }

    globalRank = list.sort((a,b)=>b.avg-a.avg);
  }

  globalRank.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${r.company}</td><td class="num">${fmtPct(r.avg)}</td><td class="num">${r.weeks}</td>`;
    gBody.appendChild(tr);
  });

  // 5) Mejor vendedor por empresa (MES PONDERADO)
  const bestBody = $("bestByCompany").querySelector("tbody");
  bestBody.innerHTML="";

  for(const c of COMPANIES){
    const blocksByName = new Map(); // name -> [{week, rows}]
    for(let w=1; w<=5; w++){
      const rec = bucket[makeKey(c, String(w))];
      if(!rec) continue;

      const pe = getParsedEmployeesFromRec(rec);
      const emps = asArray(pe.employees);

      emps.forEach(e=>{
        if(!e?.name || e.name==="SIN NOMBRE") return;
        if(!Array.isArray(e.rows) || e.rows.length===0) return;

        if(!blocksByName.has(e.name)) blocksByName.set(e.name, []);
        blocksByName.get(e.name).push({week:w, rows:e.rows});
      });
    }

    const scored = [...blocksByName.entries()]
      .map(([name, blocks])=>{
        const r = aggregateEmployeeMonthScore(blocks);
        return {name, score:r.score, weeks:r.weeks};
      })
      .filter(x=>x.score!=null && isFinite(x.score))
      .sort((a,b)=>b.score-a.score);

    const tr=document.createElement("tr");
    if(scored.length===0){
      tr.innerHTML = `<td>${c}</td><td>—</td><td class="num">—</td><td class="num">0</td>`;
    }else{
      tr.innerHTML = `<td>${c}</td><td>${scored[0].name}</td><td class="num">${fmtPct(scored[0].score)}</td><td class="num">${scored[0].weeks}</td>`;
    }
    bestBody.appendChild(tr);
  }

  // ✅ Charts
  renderCharts({aggregateMonthlyCompanyKpi, employeeEfficiencyByCompany});

  if(!hasAny){
    setMsg($("resMsg"), "No hay datos guardados para esa empresa/mes. Ve a Datos y guarda semanas.", "warn");
    $("resMsg").style.display="block";
  } else {
    $("resMsg").style.display="none";
  }
}

/** ==============================
 *  Tabs
 *  ============================== */
function showTab(name){
  ["datos","resultados","config"].forEach(t=>{
    $("tab-"+t).style.display = (t===name) ? "grid" : "none";
  });
  document.querySelectorAll(".tab").forEach(b=>{
    b.classList.toggle("active", b.dataset.tab===name);
  });
}

/** ==============================
 *  Init
 *  ============================== */
(function init(){
  fillCompanies($("companySelect"));
  fillCompanies($("resCompany"));

  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>showTab(b.dataset.tab));
  });

  $("btnPreview").addEventListener("click", ()=>preview());
  $("btnSave").addEventListener("click", ()=>{ preview(); saveWeek(); });
  $("btnLoad").addEventListener("click", ()=>loadWeek());
  $("btnClearWeek").addEventListener("click", ()=>clearWeekInputs());
  $("btnBuild").addEventListener("click", ()=>buildResults());

  $("btnExport").addEventListener("click", ()=>exportJSON());
  $("btnImport").addEventListener("click", ()=> $("importFile").click());
  $("importFile").addEventListener("change", (e)=>{
    if(e.target.files && e.target.files[0]) importJSON(e.target.files[0]);
    e.target.value="";
  });
  $("btnClearAll").addEventListener("click", ()=>clearAll());

  if($("empWeekView")){
    $("empWeekView").addEventListener("change", ()=>buildResults());
  }
  if($("cmpWeekFilter")){
    $("cmpWeekFilter").addEventListener("change", ()=>buildResults());
  }
  if($("globalWeekView")){
    $("globalWeekView").addEventListener("change", ()=>buildResults());
  }

  if($("btnOpenAllMonthly")){
    $("btnOpenAllMonthly").addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      setMonthlyBreakdowns(true);
    });
  }
  if($("btnCloseAllMonthly")){
    $("btnCloseAllMonthly").addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      setMonthlyBreakdowns(false);
    });
  }

  applyMode();
  $("btnSaveConfig").addEventListener("click", ()=>{
    const current = loadCfg();
    const nextMode = $("modeSelect").value;
    const pin = $("modePin").value || "";

    if(nextMode==="admin" && current.pin){
      const ask = prompt("PIN para entrar a Admin:");
      if(ask !== current.pin){
        setMsg($("cfgMsg"), "PIN incorrecto.", "bad");
        $("cfgMsg").style.display="block";
        applyMode();
        return;
      }
    }

    saveCfg({mode: nextMode, pin});
    applyMode();
    setMsg($("cfgMsg"), "Config guardada ✅", "ok");
    $("cfgMsg").style.display="block";
    setTimeout(()=> $("cfgMsg").style.display="none", 2000);
  });

  applyMode();
})();
</script>
</body>
</html>

  
